# =============================
# âš ï¸ é‡è¦: CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯terraform destroyå‰ã«å¿…ãšæ‰‹å‹•ã§å‰Šé™¤ã—ã¦ãã ã•ã„ï¼
# AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«â†’CloudFrontâ†’è©²å½“ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³â†’Disableâ†’Delete
# ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨å¾ªç’°å‚ç…§ã‚¨ãƒ©ãƒ¼ã§destroyã«å¤±æ•—ã—ã¾ã™ã€‚
# =============================

name: ğŸ—‘ï¸ Destroy AWS Infrastructure (Safe)

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    inputs:
      environment:
        description: 'Which environment to destroy?'
        required: true
        default: 'all'
        type: choice
        options:
          - frontend
          - backend
          - all
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string
      double_confirm:
        description: 'Type project name "nestjs-hannibal-3" to double confirm'
        required: true
        type: string

jobs:
  destroy:
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.confirm_destroy == 'DESTROY' && 
      github.event.inputs.double_confirm == 'nestjs-hannibal-3'
    steps:
      - name: ğŸ›‘ Destruction Warning
        run: |
          echo "âš ï¸  WARNING: This will PERMANENTLY DELETE AWS resources!"
          echo "ğŸ“‹ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ’° This will stop AWS billing for this project (except for ECR/S3 tfstate/CloudTrail logs/OAC)"
          echo "ğŸ”„ Resources can be recreated later with terraform apply"
          echo "â— ECRãƒªãƒã‚¸ãƒˆãƒªãƒ»S3ãƒã‚±ãƒƒãƒˆï¼ˆtfstateãƒ»CloudTrailãƒ­ã‚°ï¼‰ãƒ»OACã¯çµ¶å¯¾ã«æ¶ˆã—ã¾ã›ã‚“ï¼"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      # âš ï¸ ç«¶åˆã—ã‚„ã™ã„ãƒªã‚½ãƒ¼ã‚¹ã‚’äº‹å‰å‰Šé™¤ï¼ˆTerraform destroyã®æˆåŠŸç‡å‘ä¸Šã®ãŸã‚ï¼‰
      # ç†ç”±: ECSã‚µãƒ¼ãƒ“ã‚¹ã€ALBã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãªã©ã¯ä¾å­˜é–¢ä¿‚ã§Terraform destroyãŒå¤±æ•—ã—ã‚„ã™ã„
      # é †ç•ª: ä¾å­˜é–¢ä¿‚ã®é€†é †ï¼ˆä¸‹æµâ†’ä¸Šæµï¼‰ã§å‰Šé™¤
      # ã‚¨ãƒ©ãƒ¼å‡¦ç†: 2>/dev/null || true ã§ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
      - name: Clean up existing AWS resources (ECS/ALB/SG)
        run: |
          # 1. ECSã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ï¼ˆdesired countã‚’0ã«ã—ã¦ã‹ã‚‰å‰Šé™¤ï¼‰
          echo "ğŸ—‘ï¸ Cleaning up ECS service..."
          aws ecs update-service --cluster nestjs-hannibal-3-cluster --service nestjs-hannibal-3-api-service --desired-count 0 --region ap-northeast-1 2>/dev/null || true
          sleep 10  # ECSã‚¿ã‚¹ã‚¯ã®åœæ­¢å®Œäº†ã‚’å¾…ã¤
          aws ecs delete-service --cluster nestjs-hannibal-3-cluster --service nestjs-hannibal-3-api-service --force --region ap-northeast-1 2>/dev/null || true

          # 2. ECSã‚¯ãƒ©ã‚¹ã‚¿å‰Šé™¤ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤å¾Œã«å®Ÿè¡Œï¼‰
          echo "ğŸ—‘ï¸ Cleaning up ECS cluster..."
          aws ecs delete-cluster --cluster nestjs-hannibal-3-cluster --region ap-northeast-1 2>/dev/null || true

          # 3. ALBå‰Šé™¤ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒæ®‹ã£ã¦ã„ã‚‹ã¨å¤±æ•—ã™ã‚‹ãŸã‚å…ˆã«å‰Šé™¤ï¼‰
          echo "ğŸ—‘ï¸ Cleaning up ALB..."
          ALB_ARN=$(aws elbv2 describe-load-balancers --names nestjs-hannibal-3-alb --region ap-northeast-1 --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "None")
          if [ "$ALB_ARN" != "None" ] && [ "$ALB_ARN" != "null" ]; then
            aws elbv2 delete-load-balancer --load-balancer-arn "$ALB_ARN" --region ap-northeast-1
            sleep 60  # ALBå‰Šé™¤å®Œäº†ã‚’å¾…ã¤ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ï¼‰
          fi

          # 4. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ï¼ˆALBå‰Šé™¤å¾Œã«å®Ÿè¡Œï¼‰
          echo "ğŸ—‘ï¸ Cleaning up target group..."
          TG_ARN=$(aws elbv2 describe-target-groups --names nestjs-hannibal-3-tg --region ap-northeast-1 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "None")
          if [ "$TG_ARN" != "None" ] && [ "$TG_ARN" != "null" ]; then
            aws elbv2 delete-target-group --target-group-arn "$TG_ARN" --region ap-northeast-1
          fi

          sleep 30  # ä¾å­˜é–¢ä¿‚ã®ã‚¯ãƒªã‚¢ã‚’å¾…ã¤

          # 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ï¼ˆECSã‚¿ã‚¹ã‚¯ã‚„ALBãŒå‰Šé™¤ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œï¼‰
          echo "ğŸ—‘ï¸ Cleaning up security groups..."
          SG_ECS_ID=$(aws ec2 describe-security-groups --group-names nestjs-hannibal-3-ecs-service-sg --region ap-northeast-1 --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null || echo "None")
          if [ "$SG_ECS_ID" != "None" ] && [ "$SG_ECS_ID" != "null" ]; then
            aws ec2 delete-security-group --group-id "$SG_ECS_ID" --region ap-northeast-1 2>/dev/null || true
          fi

          SG_ALB_ID=$(aws ec2 describe-security-groups --group-names nestjs-hannibal-3-alb-sg --region ap-northeast-1 --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null || echo "None")
          if [ "$SG_ALB_ID" != "None" ] && [ "$SG_ALB_ID" != "null" ]; then
            aws ec2 delete-security-group --group-id "$SG_ALB_ID" --region ap-northeast-1 2>/dev/null || true
          fi

          # 6. IAMãƒ­ãƒ¼ãƒ«å‰Šé™¤ï¼ˆãƒãƒªã‚·ãƒ¼ã‚’ãƒ‡ã‚¿ãƒƒãƒã—ã¦ã‹ã‚‰å‰Šé™¤ï¼‰
          echo "ğŸ—‘ï¸ Cleaning up IAM role..."
          aws iam detach-role-policy --role-name nestjs-hannibal-3-ecs-task-execution-role --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy 2>/dev/null || true
          aws iam delete-role --role-name nestjs-hannibal-3-ecs-task-execution-role 2>/dev/null || true

          # 7. RDSå‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤å‰ã«å®Ÿè¡Œï¼‰
          echo "ğŸ—‘ï¸ Cleaning up RDS instance..."
          aws rds delete-db-instance --db-instance-identifier nestjs-hannibal-3-postgres --skip-final-snapshot --region ap-northeast-1 2>/dev/null || true
          echo "â³ Waiting for RDS deletion (this may take several minutes)..."
          sleep 120  # RDSå‰Šé™¤ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹

          # 8. RDSã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤
          echo "ğŸ—‘ï¸ Cleaning up RDS subnet group..."
          aws rds delete-db-subnet-group --db-subnet-group-name nestjs-hannibal-3-db-subnet-group --region ap-northeast-1 2>/dev/null || true

          # 9. RDSã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤
          echo "ğŸ—‘ï¸ Cleaning up RDS security group..."
          SG_RDS_ID=$(aws ec2 describe-security-groups --group-names nestjs-hannibal-3-rds-sg --region ap-northeast-1 --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null || echo "None")
          if [ "$SG_RDS_ID" != "None" ] && [ "$SG_RDS_ID" != "null" ]; then
            aws ec2 delete-security-group --group-id "$SG_RDS_ID" --region ap-northeast-1 2>/dev/null || true
          fi

          # 10. ç›£è¦–ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ï¼ˆCloudWatch Alarms, SNS Topic, Dashboardï¼‰
          echo "ğŸ—‘ï¸ Cleaning up monitoring resources..."
          
          # CloudWatch Alarmså‰Šé™¤
          aws cloudwatch delete-alarms --alarm-names \
            "nestjs-hannibal-3-ecs-cpu-high" \
            "nestjs-hannibal-3-ecs-memory-high" \
            "nestjs-hannibal-3-ecs-task-stopped" \
            "nestjs-hannibal-3-rds-cpu-high" \
            "nestjs-hannibal-3-rds-connections-high" \
            "nestjs-hannibal-3-alb-response-time-high" \
            "nestjs-hannibal-3-alb-5xx-error-rate-high" \
            --region ap-northeast-1 2>/dev/null || true
          
          # CloudWatch Dashboardå‰Šé™¤
          aws cloudwatch delete-dashboards --dashboard-names "hannibal-system-dashboard" --region ap-northeast-1 2>/dev/null || true
          
          # SNS Topicå‰Šé™¤
          SNS_TOPIC_ARN=$(aws sns list-topics --region ap-northeast-1 --query 'Topics[?contains(TopicArn, `nestjs-hannibal-3-alerts`)].TopicArn' --output text 2>/dev/null || echo "None")
          if [ "$SNS_TOPIC_ARN" != "None" ] && [ "$SNS_TOPIC_ARN" != "" ]; then
            aws sns delete-topic --topic-arn "$SNS_TOPIC_ARN" --region ap-northeast-1 2>/dev/null || true
          fi

          # 11. CloudWatchãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ï¼ˆECSã‚¿ã‚¹ã‚¯å‰Šé™¤å¾Œã«å®Ÿè¡Œï¼‰
          echo "ğŸ—‘ï¸ Cleaning up CloudWatch log group..."
          aws logs delete-log-group --log-group-name /ecs/nestjs-hannibal-3-api-task --region ap-northeast-1 2>/dev/null || true

          # 12. CloudTrailå‰Šé™¤ï¼ˆS3ãƒ­ã‚°ã¯ä¿æŒï¼‰
          echo "ğŸ—‘ï¸ Cleaning up CloudTrail (keeping S3 logs for audit)..."
          aws cloudtrail delete-trail --name nestjs-hannibal-3-terraform-trail --region ap-northeast-1 2>/dev/null || true

          # 13. Access Analyzerå‰Šé™¤
          echo "ğŸ—‘ï¸ Cleaning up Access Analyzer..."
          aws accessanalyzer delete-analyzer --analyzer-name nestjs-hannibal-3-analyzer --region ap-northeast-1 2>/dev/null || true

          echo "âœ… CLI cleanup completed - Terraform destroy can now proceed safely"
          echo "ğŸ“‹ CloudTrail logs preserved in S3 for security audit purposes"

      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‰Šé™¤
      - name: ğŸ¨ Destroy Frontend Infrastructure
        if: github.event.inputs.environment == 'frontend' || github.event.inputs.environment == 'all'
        run: |
          echo "ğŸ—‘ï¸ Destroying frontend resources..."
          yes | terraform init
          # CloudFrontã¯æ‰‹å‹•å‰Šé™¤æ¸ˆã¿ãªã®ã§ã€enable_cloudfront=falseã§destroy
          terraform destroy -auto-approve -var="api_alb_dns_name=" -var="enable_cloudfront=false"
          echo "âœ… Frontend infrastructure destroyed"
        working-directory: ./terraform/frontend

      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‰Šé™¤
      - name: ğŸ”§ Destroy Backend Infrastructure
        if: github.event.inputs.environment == 'backend' || github.event.inputs.environment == 'all'
        run: |
          echo "ğŸ—‘ï¸ Destroying backend resources..."
          yes | terraform init
          terraform destroy -auto-approve -var="client_url_for_cors="
          echo "âœ… Backend infrastructure destroyed"
        working-directory: ./terraform/backend

      - name: ğŸ‰ Cleanup Complete
        run: |
          echo "ğŸ‰ Infrastructure cleanup completed!"
          echo "ğŸ’° AWS billing should stop within 1-2 hours (except for ECR/S3 tfstate/CloudTrail logs/OAC)"
          echo "ğŸ“Š Check AWS Cost Explorer to confirm"
          echo ""
          echo "ğŸ”„ To redeploy later:"
          echo "  1. Push to feature/github-actions branch"
          echo "  2. Or run terraform apply manually"
