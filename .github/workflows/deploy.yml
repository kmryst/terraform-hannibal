# .github/workflows/deploy.yml (デバッグ強化版)

name: Deploy NestJS Hannibal App

on:
  pull_request:
    branches: [ec2s3cf] # トリガーブランチ
  push:
    branches: [ec2s3cf] # トリガーブランチ

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for Backend
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Backend Dependencies
        run: npm ci

      - name: Run Backend Tests
        run: npm test

      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./client

      - name: Run Frontend Tests
        run: echo "Frontend tests would run here (e.g., npm run test)"
        working-directory: ./client

  deploy:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/ec2s3cf'
    runs-on: ubuntu-latest
    outputs:
      s3_bucket_name: ${{ steps.get_terraform_outputs.outputs.s3_bucket_name }}
      cloudfront_distribution_id: ${{ steps.get_terraform_outputs.outputs.cloudfront_distribution_id }}
      ec2_instance_id: ${{ steps.get_terraform_outputs.outputs.ec2_instance_id }}
      backend_eip_address: ${{ steps.get_terraform_outputs.outputs.backend_eip_address }}
      cloudfront_domain_name: ${{ steps.get_terraform_outputs.outputs.cloudfront_domain_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        working-directory: ./terraform
        continue-on-error: true

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve -no-color
        working-directory: ./terraform

      - name: Get Terraform Outputs
        id: get_terraform_outputs
        run: |
          echo "Retrieving Terraform outputs..."
          cd ./terraform
          terraform output -json > tf_outputs.json
          echo "--- Terraform Outputs (JSON) ---"
          cat tf_outputs.json
          echo "--------------------------------"
          cd ..
          echo "s3_bucket_name=$(jq -r '.s3_bucket_name.value' ./terraform/tf_outputs.json)" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$(jq -r '.cloudfront_distribution_id.value' ./terraform/tf_outputs.json)" >> $GITHUB_OUTPUT
          echo "ec2_instance_id=$(jq -r '.ec2_instance_id.value' ./terraform/tf_outputs.json)" >> $GITHUB_OUTPUT
          echo "backend_eip_address=$(jq -r '.backend_eip_address.value' ./terraform/tf_outputs.json)" >> $GITHUB_OUTPUT
          echo "cloudfront_domain_name=$(jq -r '.cloudfront_domain_name.value' ./terraform/tf_outputs.json)" >> $GITHUB_OUTPUT
          echo "::set-output name=s3_bucket_name::$(jq -r '.s3_bucket_name.value' ./terraform/tf_outputs.json)"
          echo "::set-output name=cloudfront_distribution_id::$(jq -r '.cloudfront_distribution_id.value' ./terraform/tf_outputs.json)"
          echo "::set-output name=ec2_instance_id::$(jq -r '.ec2_instance_id.value' ./terraform/tf_outputs.json)"
          echo "::set-output name=backend_eip_address::$(jq -r '.backend_eip_address.value' ./terraform/tf_outputs.json)"
          echo "::set-output name=cloudfront_domain_name::$(jq -r '.cloudfront_domain_name.value' ./terraform/tf_outputs.json)"
        working-directory: ./

      - name: Setup Node.js for Frontend Build
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Frontend Dependencies for Build
        run: npm ci
        working-directory: ./client

      - name: Build Frontend
        run: npm run build
        working-directory: ./client

      - name: Deploy Frontend to S3
        run: |
          S3_BUCKET="${{ steps.get_terraform_outputs.outputs.s3_bucket_name }}"
          if [ -z "$S3_BUCKET" ]; then
            echo "::error::S3 bucket name not found in Terraform outputs."
            exit 1
          fi
          echo "Deploying frontend to bucket: $S3_BUCKET"
          aws s3 sync ./client/dist "s3://$S3_BUCKET" --delete

      - name: Invalidate CloudFront Cache
        run: |
          CF_DIST_ID="${{ steps.get_terraform_outputs.outputs.cloudfront_distribution_id }}"
          if [ -z "$CF_DIST_ID" ]; then
            echo "::error::CloudFront distribution ID not found in Terraform outputs."
            exit 1
          fi
          echo "Invalidating CloudFront cache for distribution: $CF_DIST_ID"
          aws cloudfront create-invalidation --distribution-id "$CF_DIST_ID" --paths "/*"

      # --- ★★★ EC2へのバックエンドデプロイ (SSM経由、デバッグ強化版) ★★★ ---
      - name: Deploy Backend to EC2 via SSM
        run: |
          INSTANCE_ID="${{ steps.get_terraform_outputs.outputs.ec2_instance_id }}"

          if [ -z "$INSTANCE_ID" ]; then
            echo "::error::EC2 instance ID not found in Terraform outputs."
            exit 1
          fi

          echo "Deploying backend to EC2 instance: $INSTANCE_ID"

          # --- 追加: AWS認証情報を確認 ---
          echo "Checking AWS Caller Identity..."
          aws sts get-caller-identity || { echo "::error::Failed to verify AWS caller identity. Check credentials."; exit 1; }
          echo "AWS Caller Identity verified."
          # --- 確認終了 ---

          # --- SSMコマンド用スクリプト定義 (変更なし、ただしGit URLのプレースホルダーに注意) ---
          read -r -d '' SCRIPT_CONTENT << 'EOF'
          #!/bin/bash
          set -eo pipefail
          echo "--- Starting deployment script on EC2 as user: $(whoami) ---"
          sudo -i -u ec2-user bash << 'INNER_EOF'
            set -eo pipefail
            echo "--- Running commands as user: $(whoami) in directory: $(pwd) ---"
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then source "$NVM_DIR/nvm.sh"; echo "NVM loaded."; else echo "::error::NVM script not found."; exit 1; fi
            echo "Node: $(node -v), npm: $(npm -v), pm2: $(pm2 -v)"
            cd /home/ec2-user || { echo "::error::cd /home/ec2-user failed"; exit 1; }
            APP_DIR="nestjs-hannibal-3"
            echo "Removing old $APP_DIR..."; rm -rf "$APP_DIR"; echo "Old dir removed."
            echo "Cloning $APP_DIR..."
            # !!! 重要: YOUR_GITHUB_USERNAME_OR_ORG を実際のGitHubユーザー名または組織名に置き換えてください !!!
            GIT_REPO_URL="https://github.com/YOUR_GITHUB_USERNAME_OR_ORG/nestjs-hannibal-3.git"
            git clone -b ec2s3cf "$GIT_REPO_URL" "$APP_DIR" || { echo "::error::git clone failed"; exit 1; }
            echo "Cloned."
            cd "$APP_DIR" || { echo "::error::cd $APP_DIR failed"; exit 1; }; echo "Changed to $(pwd)"
            echo "Installing dependencies..."; npm ci --legacy-peer-deps || { echo "::error::npm ci failed"; exit 1; }; echo "Deps installed."
            echo "Building app..."; npm run build || { echo "::error::npm run build failed"; exit 1; }; echo "Build complete."
            PM2_APP_NAME="nestjs-api"; echo "Handling PM2 process $PM2_APP_NAME..."; pm2 stop "$PM2_APP_NAME" || true; pm2 delete "$PM2_APP_NAME" || true; echo "Old PM2 process handled."
            echo "Starting PM2 process $PM2_APP_NAME..."; pm2 start dist/main.js --name "$PM2_APP_NAME" || { echo "::error::pm2 start failed"; exit 1; }; echo "PM2 started."
            echo "Saving PM2 list..."; pm2 save || echo "::warning::pm2 save failed."; echo "PM2 list saved."
            echo "--- PM2 status ---"; pm2 list; echo "------------------"
          INNER_EOF
          echo "--- Deployment script on EC2 finished successfully ---"
          EOF
          # --- スクリプト定義終了 ---

          # --- JSON変換 (変更なし) ---
          COMMANDS_JSON=$(echo "$SCRIPT_CONTENT" | jq -Rs '. | split("\n") | map(select(length > 0))')
          if [ -z "$COMMANDS_JSON" ] || [ "$COMMANDS_JSON" == "[]" ]; then
            echo "::error::Failed to create JSON commands using jq or script content is empty."
            exit 1
          fi
          # --- JSON変換終了 ---

          echo "Attempting to send SSM command to instance $INSTANCE_ID..."

          # --- 変更: send-command を直接実行し、終了コードをチェック ---
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\": $COMMANDS_JSON}" \
            --timeout-seconds 600 \
            --output json # エラー時に詳細なJSONが出力されるように変更

          # 直前のコマンドの終了コードを確認
          EXIT_CODE=$?

          if [ $EXIT_CODE -ne 0 ]; then
            # エラーメッセージの直前に失敗したコマンドが出力されるはず
            echo "::error::'aws ssm send-command' failed with exit code $EXIT_CODE. See AWS CLI output above for details."
            exit 1
          else
            # 成功した場合、コマンドIDは取得していないが、実行自体は成功したことを示す
            echo "'aws ssm send-command' request was sent successfully (Command ID not captured in this debug version)."
            # このデバッグバージョンでは、send-commandが成功した時点でステップを正常終了させる
            # 実際にEC2上でスクリプトが成功したかは、この後の手動確認や別の方法で確認が必要
            echo "Skipping command execution status check (wait, list-invocations) in this debug version."
            # ※注意: ここで exit 0 しないと、後続の処理がなければスクリプトは最後まで実行され、
            # 最後に echo "Backend deployment step finished..." が表示される
          fi

          # --- 以下の処理は send-command のエラー特定中は不要なためコメントアウト ---
          # if [ -z "$COMMAND_ID" ]; then
          #   echo "::error::Failed to send SSM command or retrieve Command ID."
          #   exit 1
          # fi
          # echo "SSM Command ID: $COMMAND_ID. Waiting for completion..."
          # aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" || echo "::warning::SSM command wait timed out or failed for command $COMMAND_ID on instance $INSTANCE_ID. Proceeding to check status."
          # echo "Waiting a few seconds before fetching results..."
          # sleep 15
          # echo "Checking command execution results for $COMMAND_ID..."
          # OUTPUT=$(aws ssm list-command-invocations ...)
          # echo "--- SSM Command Invocation Output (JSON) ---"
          # echo "$OUTPUT" | jq .
          # echo "---------------------------------------------"
          # STATUS=$(echo "$OUTPUT" | jq -r '.[0].Status // "Unknown"')
          # OUTPUT_LOG=$(echo "$OUTPUT" | jq -r '.[0].Output // ""')
          # ERROR_LOG=$(echo "$OUTPUT" | jq -r '.[0].Error // ""')
          # if [ -n "$OUTPUT_LOG" ]; then ... fi
          # if [ -n "$ERROR_LOG" ]; then ... fi
          # if [ "$STATUS" != "Success" ]; then ... exit 1; fi
          # echo "Backend deployment to EC2 completed successfully."
          # --- コメントアウトここまで ---

          echo "Backend deployment step finished (debug version focused on send-command)."
        env:
          AWS_DEFAULT_REGION: ap-northeast-1
          AWS_REGION: ap-northeast-1
          # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        shell: bash

