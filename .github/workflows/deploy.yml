name: Deploy NestJS Hannibal App

on:
  pull_request:
    branches: [ec2s3cf] # トリガーブランチを ec2s3cf に設定
  push:
    branches: [ec2s3cf] # トリガーブランチを ec2s3cf に設定

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # バックエンドのテスト
      - name: Setup Node.js for Backend
        uses: actions/setup-node@v3
        with:
          node-version: '16' # バックエンドは Node.js 16 を使用
          cache: 'npm'

      - name: Install Backend Dependencies
        run: npm ci

      - name: Run Backend Tests
        run: npm test

      # フロントエンドのテスト
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20' # フロントエンドは Node.js 20 を使用
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Frontend Dependencies
        run: cd client && npm ci

      - name: Run Frontend Tests
        # (もしテストコマンドがあれば追記してください。例: npm run test)
        run: echo "Frontend tests would run here" # テストコマンドがない場合は削除または適切なコマンドに置き換え

  deploy:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/ec2s3cf' # デプロイ対象ブランチを ec2s3cf に設定
    runs-on: ubuntu-latest
    # ジョブの outputs を定義 (必須ではないが後で参照しやすい)
    outputs:
      s3_bucket_name: ${{ steps.get_terraform_outputs.outputs.s3_bucket_name }}
      cloudfront_distribution_id: ${{ steps.get_terraform_outputs.outputs.cloudfront_distribution_id }}
      ec2_instance_id: ${{ steps.get_terraform_outputs.outputs.ec2_instance_id }}

    steps:
      - uses: actions/checkout@v3

      # AWSの認証情報を設定
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # Terraformをセットアップ (terraform_wrapper: false を追加)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.0.0 # Terraformのバージョン指定 (必要に応じて変更)
          terraform_wrapper: false # これを追加

      # Terraformを初期化
      - name: Terraform Init
        id: init # ステップIDを追加
        run: terraform init
        working-directory: ./terraform # terraformディレクトリで実行

      # Terraformプランを表示 (オプション)
      - name: Terraform Plan
        id: plan # ステップIDを追加
        run: terraform plan
        working-directory: ./terraform # terraformディレクトリで実行

      # Terraformを適用（インフラをデプロイ）
      - name: Terraform Apply
        id: apply # ステップIDを追加
        run: terraform apply -auto-approve
        working-directory: ./terraform # terraformディレクトリで実行

      # Terraform Outputs を取得してステップの Output に設定
      - name: Get Terraform Outputs
        id: get_terraform_outputs # このステップのID
        run: |
          # terraform output の結果を整形してステップの outputs に設定
          S3_BUCKET=$(terraform output -raw s3_bucket_name | head -n 1 | tr -d '\n' | tr -d '\r')
          CF_DIST_ID=$(terraform output -raw cloudfront_distribution_id | head -n 1 | tr -d '\n' | tr -d '\r')
          EC2_ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=nestjs-hannibal-backend" --query "Reservations[].Instances[?State.Name=='running'].InstanceId" --output text | tr -d '\n' | tr -d '\r')

          # GitHub Actions の新しい構文を使用
          echo "s3_bucket_name=$S3_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$CF_DIST_ID" >> $GITHUB_OUTPUT
          echo "ec2_instance_id=$EC2_ID" >> $GITHUB_OUTPUT

          # デバッグ用に取得した値を出力
          echo "S3 Bucket Name: $S3_BUCKET"
          echo "CloudFront Distribution ID: $CF_DIST_ID"
          echo "EC2 Instance ID: $EC2_ID"
        working-directory: ./terraform # terraformディレクトリで実行

      # フロントエンドのビルド
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20' # フロントエンドは Node.js 20 を使用
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./client # client ディレクトリで実行

      - name: Build Frontend
        run: npm run build
        working-directory: ./client # client ディレクトリで実行

      # S3へのデプロイ
      - name: Deploy to S3
        run: |
          echo "Deploying to bucket: ${{ steps.get_terraform_outputs.outputs.s3_bucket_name }}"
          aws s3 sync ./client/dist "s3://${{ steps.get_terraform_outputs.outputs.s3_bucket_name }}" --delete

      # CloudFrontキャッシュの無効化
      - name: Invalidate CloudFront Cache
        run: |
          echo "Invalidating CloudFront cache for distribution: ${{ steps.get_terraform_outputs.outputs.cloudfront_distribution_id }}"
          aws cloudfront create-invalidation --distribution-id "${{ steps.get_terraform_outputs.outputs.cloudfront_distribution_id }}" --paths "/*"

      # バックエンドのデプロイ（EC2）- PM2のインストールと設定を改善
      - name: Deploy Backend to EC2 via SSM
        run: |
          INSTANCE_ID="${{ steps.get_terraform_outputs.outputs.ec2_instance_id }}"

          if [ -z "$INSTANCE_ID" ]; then
            echo "EC2 instance ID not found in Terraform outputs or instance not running."
            exit 1
          fi

          echo "Deploying to EC2 instance: $INSTANCE_ID"

          # Node.jsとnpmの確認とPM2のインストール（絶対パスとシンボリックリンクの作成）
          echo "Installing PM2 with proper path configuration..."
          SETUP_COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "#!/bin/bash",
              "# Node.jsとnpmのバージョン確認",
              "echo \"Node.js version: $(node -v || echo \"not installed\")\"",
              "echo \"npm version: $(npm -v || echo \"not installed\")\"",
              
              "# PM2のグローバルインストール",
              "echo \"Installing PM2 globally...\"",
              "sudo npm install -g pm2",
              
              "# PM2のパスを取得",
              "PM2_PATH=$(which pm2 || echo \"not found\")",
              "echo \"PM2 path: $PM2_PATH\"",
              
              "# シンボリックリンクの作成",
              "if [ \"$PM2_PATH\" != \"not found\" ]; then",
              "  sudo ln -sf $PM2_PATH /usr/bin/pm2",
              "  sudo ln -sf $(which node) /usr/bin/node",
              "  echo \"Created symbolic links for PM2 and Node.js\"",
              "else",
              "  echo \"Failed to find PM2 path\"",
              "fi",
              
              "# PATHの確認",
              "echo \"PATH: $PATH\"",
              
              "# PM2が正しくインストールされたか確認",
              "if command -v pm2 &> /dev/null; then",
              "  echo \"PM2 is correctly installed: $(pm2 -v)\"",
              "else",
              "  echo \"PM2 installation verification failed\"",
              "fi"
            ]' \
            --timeout-seconds 300 \
            --output text \
            --query "Command.CommandId")
          
          echo "Setup command ID: $SETUP_COMMAND_ID"
          echo "Waiting for setup command to complete..."
          sleep 15
          
          # セットアップコマンドの結果を確認
          aws ssm get-command-invocation \
            --command-id $SETUP_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --query "{Status:Status,StatusDetails:StatusDetails}" \
            --output text
          
          # セットアップコマンドの詳細出力を確認
          echo "Setup command output:"
          aws ssm list-command-invocations \
            --command-id $SETUP_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --details \
            --query "CommandInvocations[].CommandPlugins[].Output" \
            --output text || echo "Failed to get setup command output"
          
          # アプリケーションのデプロイ
          echo "Deploying application..."
          DEPLOY_COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "#!/bin/bash",
              "cd /home/ec2-user",
              "echo \"Removing old application directory...\"",
              "rm -rf nestjs-hannibal-3 || true",
              "echo \"Cloning repository...\"",
              "git clone -b ec2s3cf https://github.com/yourusername/nestjs-hannibal-3.git || { echo \"Git clone failed\"; exit 1; }",
              "cd nestjs-hannibal-3 || { echo \"Failed to change directory\"; exit 1; }",
              "echo \"Installing dependencies...\"",
              "npm ci --legacy-peer-deps || npm install",
              "echo \"Building application...\"",
              "npm run build || { echo \"Build failed\"; exit 1; }"
            ]' \
            --timeout-seconds 600 \
            --output text \
            --query "Command.CommandId")
          
          echo "Deploy command ID: $DEPLOY_COMMAND_ID"
          echo "Waiting for deploy command to complete..."
          sleep 60
          
          # デプロイコマンドの結果を確認
          aws ssm get-command-invocation \
            --command-id $DEPLOY_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --query "{Status:Status,StatusDetails:StatusDetails}" \
            --output text
          
          # デプロイコマンドの詳細出力を確認
          echo "Deploy command output:"
          aws ssm list-command-invocations \
            --command-id $DEPLOY_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --details \
            --query "CommandInvocations[].CommandPlugins[].Output" \
            --output text || echo "Failed to get deploy command output"
          
          # PM2でアプリケーションを起動（絶対パスを使用）
          echo "Starting application with PM2..."
          START_COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "#!/bin/bash",
              "cd /home/ec2-user/nestjs-hannibal-3",
              
              "# PM2のパスを取得",
              "PM2_PATH=$(which pm2)",
              "if [ -z \"$PM2_PATH\" ]; then",
              "  PM2_PATH=/usr/bin/pm2",
              "fi",
              "echo \"Using PM2 at: $PM2_PATH\"",
              
              "# 既存のプロセスを停止",
              "$PM2_PATH stop nestjs-api || true",
              "$PM2_PATH delete nestjs-api || true",
              
              "# 新しいプロセスを開始",
              "echo \"Starting application with PM2...\"",
              "$PM2_PATH start dist/main.js --name nestjs-api",
              "$PM2_PATH save",
              
              "# ステータス確認",
              "echo \"PM2 status:\"",
              "$PM2_PATH status",
              
              "# 代替方法: PM2が使えない場合はnodeで直接起動",
              "if [ $? -ne 0 ]; then",
              "  echo \"PM2 failed, starting with node directly...\"",
              "  nohup node dist/main.js > app.log 2>&1 &",
              "  echo $! > app.pid",
              "  echo \"Started node process with PID: $(cat app.pid)\"",
              "fi"
            ]' \
            --timeout-seconds 300 \
            --output text \
            --query "Command.CommandId")
          
          echo "Start command ID: $START_COMMAND_ID"
          echo "Waiting for start command to complete..."
          sleep 15
          
          # 起動コマンドの結果を確認
          aws ssm get-command-invocation \
            --command-id $START_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --query "{Status:Status,StatusDetails:StatusDetails}" \
            --output text
          
          # 起動コマンドの詳細出力を確認
          echo "Start command output:"
          aws ssm list-command-invocations \
            --command-id $START_COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --details \
            --query "CommandInvocations[].CommandPlugins[].Output" \
            --output text || echo "Failed to get start command output"
