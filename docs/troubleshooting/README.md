# トラブルシューティング事例

## 1. CodeDeploy Blue/Green デプロイ設定

**課題**: ECS Blue/Greenデプロイメントの実装

**対応内容**:
- ターゲットグループの順序を正しく設定（Blue → Green）
- CodeDeployに必要なIAM権限を段階的に追加（PassRole、ECS操作権限）
- ヘルスチェックパスを `/health` に統一

**成果**: 安定したBlue/Greenデプロイメントを実現し、5分以内の無停止切替を達成

**学び**: AWS公式ドキュメントとTerraformプロバイダーの仕様差異を理解し、段階的なデバッグの重要性を認識

## 2. IAM Permission Boundary による最小権限設計

**課題**: セキュリティを保ちながらCI/CDパイプラインに必要な権限を付与

**対応内容**:
- Permission Boundaryで権限の上限を設定
- 必要な権限を段階的に追加（DynamoDB、CodeDeploy、ECS等）
- CloudTrailで権限使用状況を監視

**成果**: 最小権限の原則を実装しながら、完全自動化されたCI/CDを実現

**学び**: セキュリティと利便性のバランスを取る設計の重要性

## 3. Terraform リソース削除順序の最適化

**課題**: `terraform destroy` 時のTarget Group削除エラー

**対応内容**:
- リソース間の依存関係を分析
- destroy.ymlで削除順序を制御（CloudFront → ALB → ECS → RDS）
- 各モジュールの削除を段階的に実行

**成果**: クリーンな環境削除を実現し、コスト管理を効率化

**学び**: IaCにおけるリソース依存関係の理解と、適切な削除戦略の重要性

## 4. 三層VPC アーキテクチャへの移行

**課題**: デフォルトVPCから本番レベルの3層VPC（Public/App/Data）への移行

**対応内容**:
- Private SubnetのECSタスクにNATゲートウェイ経由のインターネットアクセスを設定
- ルートテーブルを適切に構成（App → NAT、Data → ローカルのみ）
- セキュリティグループで最小権限通信を実装

**成果**: セキュアなネットワーク設計を実現し、DB層を完全に外部非公開化

**学び**: エンタープライズレベルのネットワーク設計とセキュリティベストプラクティス

## 5. Terraform State 管理の自動化

**課題**: State Lockによる並行実行制御

**対応内容**:
- S3 + DynamoDBでState管理を実装
- State Lockの仕組みを理解し、異常終了時の対処方法を確立
- GitHub Actionsで排他制御を実装

**成果**: 安全な並行実行制御と、チーム開発に対応可能な基盤を構築

**学び**: IaCにおける状態管理の重要性と、チーム開発を見据えた設計
