name: ğŸ—‘ï¸ Destroy AWS Infrastructure

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    inputs:
      environment:
        description: 'Which environment to destroy?'
        required: true
        default: 'all'
        type: choice
        options:
        - frontend
        - backend  
        - all
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string
      double_confirm:
        description: 'Type project name "nestjs-hannibal-3" to double confirm'
        required: true
        type: string

jobs:
  destroy:
    runs-on: ubuntu-latest
    # å®‰å…¨ç¢ºèª: ä¸¡æ–¹ã®ç¢ºèªãŒæ­£ã—ã„å ´åˆã®ã¿å®Ÿè¡Œ
    if: >
      github.event.inputs.confirm_destroy == 'DESTROY' && 
      github.event.inputs.double_confirm == 'nestjs-hannibal-3'
    
    steps:
      - name: ğŸ›‘ Destruction Warning
        run: |
          echo "âš ï¸  WARNING: This will PERMANENTLY DELETE AWS resources!"
          echo "ğŸ“‹ Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ’° This will stop AWS billing for this project"
          echo "ğŸ”„ Resources can be recreated later with terraform apply"
          
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‰Šé™¤
      - name: ğŸ¨ Destroy Frontend Infrastructure
        if: github.event.inputs.environment == 'frontend' || github.event.inputs.environment == 'all'
        run: |
          echo "ğŸ—‘ï¸ Destroying frontend resources..."
          terraform init
          terraform destroy -auto-approve
          echo "âœ… Frontend infrastructure destroyed"
        working-directory: ./terraform/frontend

      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‰Šé™¤  
      - name: ğŸ”§ Destroy Backend Infrastructure
        if: github.event.inputs.environment == 'backend' || github.event.inputs.environment == 'all'
        run: |
          echo "ğŸ—‘ï¸ Destroying backend resources..."
          terraform init
          terraform destroy -auto-approve
          echo "âœ… Backend infrastructure destroyed"
        working-directory: ./terraform/backend

      - name: ğŸ‰ Cleanup Complete
        run: |
          echo "ğŸ‰ Infrastructure cleanup completed!"
          echo "ğŸ’° AWS billing should stop within 1-2 hours"
          echo "ğŸ“Š Check AWS Cost Explorer to confirm"
          echo ""
          echo "ğŸ”„ To redeploy later:"
          echo "  1. Push to feature/github-actions branch"
          echo "  2. Or run terraform apply manually"